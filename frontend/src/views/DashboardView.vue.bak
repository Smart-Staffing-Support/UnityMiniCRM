<script setup>
import { ref, onMounted } from 'vue'
import { crmService } from '../services/api'

const stats = ref(null)
const loading = ref(true)

onMounted(async () => {
  try {
    stats.value = await crmService.getDashboardStats()
  } catch (error) {
    console.error('Failed to load dashboard stats:', error)
  } finally {
    loading.value = false
  }
})

const formatCurrency = (value) => {
  return new Intl.NumberFormat('en-US', {
    style: 'currency',
    currency: 'USD'
  }).format(value || 0)
}
</script>

<template>
  <v-container fluid>
    <v-row>
      <v-col cols="12">
        <h1 class="text-h4 font-weight-bold text-navy mb-2">Dashboard</h1>
        <p class="text-subtitle-1 text-grey">Overview of your CRM activities</p>
      </v-col>
    </v-row>

    <v-row v-if="loading">
      <v-col cols="12" class="text-center py-12">
        <v-progress-circular indeterminate color="primary" size="64"></v-progress-circular>
      </v-col>
    </v-row>

    <v-row v-else-if="stats">
      <v-col cols="12" sm="6" md="3">
        <v-card elevation="2" class="pa-4">
          <div class="d-flex align-center justify-space-between">
            <div>
              <p class="text-overline text-grey mb-1">Total Contacts</p>
              <h2 class="text-h3 font-weight-bold text-navy">{{ stats.total_contacts }}</h2>
            </div>
            <v-avatar color="primary" size="56">
              <v-icon size="32" color="white">mdi-account-multiple</v-icon>
            </v-avatar>
          </div>
        </v-card>
      </v-col>

      <v-col cols="12" sm="6" md="3">
        <v-card elevation="2" class="pa-4">
          <div class="d-flex align-center justify-space-between">
            <div>
              <p class="text-overline text-grey mb-1">Total Companies</p>
              <h2 class="text-h3 font-weight-bold text-navy">{{ stats.total_companies }}</h2>
            </div>
            <v-avatar color="secondary" size="56">
              <v-icon size="32" color="white">mdi-office-building</v-icon>
            </v-avatar>
          </div>
        </v-card>
      </v-col>

      <v-col cols="12" sm="6" md="3">
        <v-card elevation="2" class="pa-4">
          <div class="d-flex align-center justify-space-between">
            <div>
              <p class="text-overline text-grey mb-1">Active Deals</p>
              <h2 class="text-h3 font-weight-bold text-navy">{{ stats.total_deals }}</h2>
            </div>
            <v-avatar color="accent" size="56">
              <v-icon size="32" color="white">mdi-currency-usd</v-icon>
            </v-avatar>
          </div>
        </v-card>
      </v-col>

      <v-col cols="12" sm="6" md="3">
        <v-card elevation="2" class="pa-4">
          <div class="d-flex align-center justify-space-between">
            <div>
              <p class="text-overline text-grey mb-1">Total Value</p>
              <h2 class="text-h4 font-weight-bold text-navy">{{ formatCurrency(stats.total_deal_value) }}</h2>
            </div>
            <v-avatar color="success" size="56">
              <v-icon size="32" color="white">mdi-chart-line</v-icon>
            </v-avatar>
          </div>
        </v-card>
      </v-col>

      <v-col cols="12" md="6">
        <v-card elevation="2">
          <v-card-title class="text-navy font-weight-bold">
            <v-icon class="mr-2">mdi-chart-pie</v-icon>
            Deals by Stage
          </v-card-title>
          <v-divider></v-divider>
          <v-card-text>
            <v-list density="compact">
              <v-list-item
                v-for="stage in stats.deals_by_stage"
                :key="stage.stage"
              >
                <template v-slot:prepend>
                  <v-icon>mdi-circle</v-icon>
                </template>
                <v-list-item-title class="text-capitalize">
                  {{ stage.stage }}
                </v-list-item-title>
                <template v-slot:append>
                  <v-chip color="primary" size="small">{{ stage.count }}</v-chip>
                </template>
              </v-list-item>
            </v-list>
          </v-card-text>
        </v-card>
      </v-col>

      <v-col cols="12" md="6">
        <v-card elevation="2">
          <v-card-title class="text-navy font-weight-bold">
            <v-icon class="mr-2">mdi-check-circle</v-icon>
            Recent Tasks
          </v-card-title>
          <v-divider></v-divider>
          <v-card-text>
            <v-list density="compact">
              <v-list-item
                v-for="task in stats.recent_tasks"
                :key="task.id"
              >
                <v-list-item-title>{{ task.title }}</v-list-item-title>
                <v-list-item-subtitle>{{ task.due_date }}</v-list-item-subtitle>
                <template v-slot:append>
                  <v-chip
                    :color="task.priority === 'high' ? 'error' : task.priority === 'medium' ? 'warning' : 'info'"
                    size="small"
                  >
                    {{ task.priority }}
                  </v-chip>
                </template>
              </v-list-item>
            </v-list>
          </v-card-text>
        </v-card>
      </v-col>
    </v-row>
  </v-container>
</template>
